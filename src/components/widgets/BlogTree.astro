---
import type { CollectionEntry } from 'astro:content'

interface Props {
  posts: CollectionEntry<'posts'>[]
}

const { posts } = Astro.props
const currentPath = Astro.url.pathname

// Build tree structure from posts
interface TreeNode {
  name: string
  type: 'folder' | 'file'
  path: string
  post?: CollectionEntry<'posts'>
  children?: TreeNode[]
}

function buildTree(posts: CollectionEntry<'posts'>[]): TreeNode {
  const root: TreeNode = {
    name: 'posts',
    type: 'folder',
    path: '',
    children: []
  }

  posts.forEach(post => {
    const parts = post.id.split('/')
    let currentNode = root

    parts.forEach((part, index) => {
      const isFile = index === parts.length - 1
      const path = parts.slice(0, index + 1).join('/')

      if (!currentNode.children) {
        currentNode.children = []
      }

      let childNode = currentNode.children.find(n => n.name === part)

      if (!childNode) {
        childNode = {
          name: part,
          type: isFile ? 'file' : 'folder',
          path,
          children: isFile ? undefined : []
        }
        currentNode.children.push(childNode)
      }

      if (isFile) {
        childNode.post = post
      }

      currentNode = childNode
    })
  })

  // Sort alphabetically by name (files and folders mixed)
  function sortTree(node: TreeNode) {
    if (node.children) {
      node.children.sort((a, b) => a.name.localeCompare(b.name))
      node.children.forEach(sortTree)
    }
  }

  sortTree(root)
  return root
}

const tree = buildTree(posts)

// Helper function to check if a folder contains the current path
function isFolderActive(node: TreeNode, currentPath: string): boolean {
  if (node.type === 'file') {
    return currentPath === `/${node.post?.id}`
  }
  if (node.children) {
    return node.children.some(child => isFolderActive(child, currentPath))
  }
  return false
}
---

<div class="blog-tree">
  <div class="tree-header-row">
    <a href="/" class="tree-header">~/jhan</a>
    <span class="search-hint"><kbd>âŒ˜K</kbd> to search</span>
  </div>
  <div class="tree-content">
    {tree.children && tree.children.map(node => (
      <Fragment>
        {node.type === 'folder' ? (
          <details class="tree-folder" open={isFolderActive(node, currentPath)}>
            <summary role="button" tabindex="0" aria-label={`Toggle ${node.name} folder`}>
              <span class="folder-icon">ðŸ“‚</span>
              <span class="folder-name">{node.name}</span>
            </summary>
            <div class="tree-children">
              {node.children && node.children.map(child => (
                child.type === 'file' && child.post ? (
                  <a 
                    href={`/${child.post.id}`} 
                    class={`tree-file ${currentPath === `/${child.post.id}` ? 'active' : ''}`}
                  >
                    <span class="file-icon">ðŸ“„</span>
                    <span class="file-name">{child.post.data.title}</span>
                  </a>
                ) : child.type === 'folder' ? (
                  <details class="tree-folder nested" open={isFolderActive(child, currentPath)}>
                    <summary role="button" tabindex="0" aria-label={`Toggle ${child.name} folder`}>
                      <span class="folder-icon">ðŸ“‚</span>
                      <span class="folder-name">{child.name}</span>
                    </summary>
                    <div class="tree-children">
                      {child.children && child.children.map(file => (
                        file.post && (
                          <a 
                            href={`/${file.post.id}`} 
                            class={`tree-file ${currentPath === `/${file.post.id}` ? 'active' : ''}`}
                          >
                            <span class="file-icon">ðŸ“„</span>
                            <span class="file-name">{file.post.data.title}</span>
                          </a>
                        )
                      ))}
                    </div>
                  </details>
                ) : null
              ))}
            </div>
          </details>
        ) : node.post ? (
          <a 
            href={`/${node.post.id}`} 
            class={`tree-file ${currentPath === `/${node.post.id}` ? 'active' : ''}`}
          >
            <span class="file-icon">ðŸ“„</span>
            <span class="file-name">{node.post.data.title}</span>
          </a>
        ) : null}
      </Fragment>
    ))}
  </div>
</div>

<style>
  .blog-tree {
    font-family: var(--serif);
    font-size: 1rem;
    line-height: 2;
    padding: 0.5rem 0;
  }

  .tree-header-row {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 0.75rem;
  }

  .tree-header {
    font-weight: var(--font-weight-bold);
    color: var(--text-primary);
    text-decoration: none;
    transition: color 0.2s ease;
  }

  .tree-header:hover {
    color: var(--primary);
  }

  .search-hint {
    color: var(--text-tertiary);
    font-size: 0.8rem;
  }

  .search-hint kbd {
    font-family: var(--mono);
    font-size: 0.75rem;
    padding: 0.1rem 0.35rem;
    background: var(--code-bg);
    border: 1px solid var(--border);
    border-radius: 4px;
  }

  .folder-icon,
  .file-icon {
    font-size: 1rem;
    flex-shrink: 0;
  }

  .file,
  .folder {
    margin: 0.5rem 0;
  }

  .tree-folder {
    margin: 0.25rem 0;
  }

  .tree-folder summary {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    cursor: pointer;
    padding: 0.25rem 0;
    list-style: none;
    user-select: none;
    position: relative;
  }

  .tree-folder summary::-webkit-details-marker {
    display: none;
  }

  /* Chevron icon */
  .tree-folder summary::before {
    content: 'â€º';
    display: inline-block;
    width: 1rem;
    font-size: 1.2rem;
    transition: transform 0.2s ease;
    flex-shrink: 0;
  }

  .tree-folder[open] summary::before {
    transform: rotate(90deg);
  }

  .tree-folder summary:hover {
    color: var(--primary);
  }

  .tree-children {
    padding-left: 1.25rem;
    border-left: 1px solid var(--border);
    margin-left: 0.5rem;
  }

  .tree-file {
    display: flex;
    align-items: flex-start;
    gap: 0.5rem;
    padding: 0.25rem 0;
    color: var(--text-primary);
    text-decoration: none;
    transition: color 0.2s ease;
    min-width: 0;
  }

  .tree-file:hover {
    color: var(--primary);
  }

  .tree-file:hover .file-name {
    text-decoration: underline;
  }

  .tree-file.active {
    color: var(--primary);
  }

  .tree-file.active .file-name {
    text-decoration: underline;
  }

  .file-name,
  .folder-name {
    flex: 1;
    min-width: 0;
    max-width: 100%;
    word-wrap: break-word;
    overflow-wrap: break-word;
    white-space: normal;
  }

  .nested {
    margin-left: 0;
  }
</style>
