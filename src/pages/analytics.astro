---
import IndexLayout from '@/layouts/IndexLayout.astro'
import { themeConfig } from '@/config'
---

<IndexLayout
  title={`Analytics Â· ${themeConfig.site.title}`}
  description="Site analytics and statistics"
>
  <div class="analytics-page">
    <h1>Analytics</h1>

    <div class="stats-row">
      <div class="stat">
        <span class="stat-value" id="today-views">...</span>
        <span class="stat-label">views today</span>
      </div>
      <div class="stat">
        <span class="stat-value" id="all-views">...</span>
        <span class="stat-label">views all time</span>
      </div>
    </div>

    <div class="histogram-section">
      <h2>Last 60 days</h2>
      <div class="histogram" id="histogram">
        <div class="loading">loading...</div>
      </div>
      <div class="histogram-labels">
        <span id="start-date">...</span>
        <span id="end-date">...</span>
      </div>
    </div>
  </div>
</IndexLayout>

<script>
  async function loadStats() {
    try {
      const response = await fetch('/api/analytics');
      if (response.ok) {
        const data = await response.json();
        const todayEl = document.getElementById('today-views');
        const allEl = document.getElementById('all-views');
        if (todayEl) todayEl.textContent = data.humanToday?.toLocaleString() || '0';
        if (allEl) allEl.textContent = data.humanAllTime?.toLocaleString() || '0';
      }
    } catch (error) {
      console.debug('Failed to load stats:', error);
    }
  }

  async function loadHistogram() {
    try {
      const response = await fetch('/api/analytics/daily?days=60');
      if (response.ok) {
        const data = await response.json();
        const container = document.getElementById('histogram');
        const startLabel = document.getElementById('start-date');
        const endLabel = document.getElementById('end-date');

        if (container && data.days && data.days.length > 0) {
          const maxViews = Math.max(...data.days.map((d: any) => d.views), 1);

          container.innerHTML = data.days.map((day: any) => {
            const height = Math.max((day.views / maxViews) * 100, 2);
            const date = new Date(day.date + 'T00:00:00');
            const formatted = date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
            return `<div class="bar" style="height: ${height}%" title="${formatted}: ${day.views} views"></div>`;
          }).join('');

          if (startLabel && data.days[0]) {
            const d = new Date(data.days[0].date + 'T00:00:00');
            startLabel.textContent = d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
          }
          if (endLabel && data.days[data.days.length - 1]) {
            const d = new Date(data.days[data.days.length - 1].date + 'T00:00:00');
            endLabel.textContent = d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
          }
        }
      }
    } catch (error) {
      console.debug('Failed to load histogram:', error);
      const container = document.getElementById('histogram');
      if (container) container.innerHTML = '<div class="error">Failed to load</div>';
    }
  }

  loadStats();
  loadHistogram();

  document.addEventListener('astro:page-load', () => {
    loadStats();
    loadHistogram();
  });
</script>

<style is:global>
  .analytics-page {
    max-width: 100%;
  }

  h1 {
    font-size: 1rem;
    margin-bottom: 1rem;
    font-weight: var(--font-weight-bold);
  }

  h2 {
    font-size: 0.85rem;
    margin-bottom: 0.5rem;
    color: var(--text-secondary);
    font-weight: normal;
  }

  .stats-row {
    display: flex;
    gap: 2rem;
    margin-bottom: 2rem;
  }

  .stat {
    display: flex;
    flex-direction: column;
  }

  .stat-value {
    font-size: 1.5rem;
    font-weight: var(--font-weight-bold);
    line-height: 1.2;
  }

  .stat-label {
    font-size: 0.8rem;
    color: var(--text-secondary);
  }

  .histogram-section {
    margin-top: 1.5rem;
  }

  .histogram {
    display: flex;
    align-items: flex-end;
    gap: 2px;
    height: 120px;
    padding: 0.5rem 0;
  }

  .bar {
    flex: 1;
    background: var(--text-primary);
    opacity: 0.7;
    min-width: 2px;
    transition: opacity 0.15s;
    cursor: pointer;
  }

  .bar:hover {
    opacity: 1;
  }

  .histogram-labels {
    display: flex;
    justify-content: space-between;
    font-size: 0.75rem;
    color: var(--text-secondary);
    margin-top: 0.25rem;
  }

  .loading, .error {
    font-size: 0.85rem;
    color: var(--text-secondary);
  }

  @media (max-width: 768px) {
    .histogram {
      height: 80px;
    }
  }
</style>
