---
import IndexLayout from '@/layouts/IndexLayout.astro'
import { themeConfig } from '@/config'
---

<IndexLayout
  title={`Analytics Â· ${themeConfig.site.title}`}
  description="Site analytics and statistics"
  hideHeader={true}
>
  <div class="analytics-page">
    <h1>Analytics</h1>

    <div class="stats-row">
      <div class="stat">
        <span class="stat-value" id="today-views">...</span>
        <span class="stat-label">views today</span>
      </div>
      <div class="stat">
        <span class="stat-value" id="all-views">...</span>
        <span class="stat-label">views all time</span>
      </div>
    </div>

    <div class="histogram-section">
      <div class="histogram-header">
        <h2>Last <select id="days-select">
          <option value="7">7</option>
          <option value="30">30</option>
          <option value="60" selected>60</option>
        </select> days</h2>
      </div>
      <div class="histogram-container">
        <div class="histogram" id="histogram">
          <div class="loading">loading...</div>
        </div>
        <div class="tooltip" id="tooltip"></div>
      </div>
      <div class="histogram-labels">
        <span id="start-date">...</span>
        <span id="end-date">...</span>
      </div>
    </div>
  </div>
</IndexLayout>

<script>
  async function loadStats() {
    try {
      const response = await fetch('/api/analytics');
      if (response.ok) {
        const data = await response.json();
        const todayEl = document.getElementById('today-views');
        const allEl = document.getElementById('all-views');
        if (todayEl) todayEl.textContent = data.humanToday?.toLocaleString() || '0';
        if (allEl) allEl.textContent = data.humanAllTime?.toLocaleString() || '0';
      }
    } catch (error) {
      console.debug('Failed to load stats:', error);
    }
  }

  async function loadHistogram(days = 60) {
    try {
      const response = await fetch(`/api/analytics/daily?days=${days}`);
      if (response.ok) {
        const data = await response.json();
        const container = document.getElementById('histogram');
        const startLabel = document.getElementById('start-date');
        const endLabel = document.getElementById('end-date');
        const tooltip = document.getElementById('tooltip');

        if (container && data.days && data.days.length > 0) {
          const maxViews = Math.max(...data.days.map((d: any) => d.views), 1);

          container.innerHTML = data.days.map((day: any, i: number) => {
            const height = Math.max((day.views / maxViews) * 100, 2);
            return `<div class="bar" style="height: ${height}%" data-date="${day.date}" data-views="${day.views}"></div>`;
          }).join('');

          // Add hover listeners
          container.querySelectorAll('.bar').forEach(bar => {
            bar.addEventListener('mouseenter', (e) => {
              const target = e.target as HTMLElement;
              const date = new Date(target.dataset.date + 'T00:00:00');
              const formatted = date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
              const views = target.dataset.views;
              if (tooltip) {
                tooltip.textContent = `${formatted}: ${views}`;
                tooltip.style.opacity = '1';
              }
            });
            bar.addEventListener('mouseleave', () => {
              if (tooltip) tooltip.style.opacity = '0';
            });
          });

          if (startLabel && data.days[0]) {
            const d = new Date(data.days[0].date + 'T00:00:00');
            startLabel.textContent = d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
          }
          if (endLabel && data.days[data.days.length - 1]) {
            const d = new Date(data.days[data.days.length - 1].date + 'T00:00:00');
            endLabel.textContent = d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
          }
        }
      }
    } catch (error) {
      console.debug('Failed to load histogram:', error);
      const container = document.getElementById('histogram');
      if (container) container.innerHTML = '<div class="error">Failed to load</div>';
    }
  }

  // Dropdown handler
  const daysSelect = document.getElementById('days-select') as HTMLSelectElement;
  if (daysSelect) {
    daysSelect.addEventListener('change', () => {
      loadHistogram(parseInt(daysSelect.value, 10));
    });
  }

  loadStats();
  loadHistogram(60);

  document.addEventListener('astro:page-load', () => {
    loadStats();
    loadHistogram();
  });
</script>

<style is:global>
  .analytics-page {
    max-width: 100%;
  }

  h1 {
    font-size: 1rem;
    margin-bottom: 1rem;
    font-weight: var(--font-weight-bold);
  }

  h2 {
    font-size: 0.85rem;
    margin-bottom: 0.5rem;
    color: var(--text-secondary);
    font-weight: normal;
  }

  .stats-row {
    display: flex;
    gap: 2rem;
    margin-bottom: 2rem;
  }

  .stat {
    display: flex;
    flex-direction: column;
  }

  .stat-value {
    font-size: 1.5rem;
    font-weight: var(--font-weight-bold);
    line-height: 1.2;
  }

  .stat-label {
    font-size: 0.8rem;
    color: var(--text-secondary);
  }

  .histogram-section {
    margin-top: 1.5rem;
  }

  .histogram-header {
    display: flex;
    align-items: center;
  }

  .histogram-header h2 {
    display: flex;
    align-items: center;
    gap: 0.25rem;
  }

  #days-select {
    font-size: 0.85rem;
    font-family: inherit;
    background: transparent;
    border: none;
    border-bottom: 1px solid var(--text-secondary);
    color: var(--text-primary);
    cursor: pointer;
    padding: 0 0.25rem;
  }

  #days-select:focus {
    outline: none;
    border-bottom-color: var(--text-primary);
  }

  .histogram-container {
    position: relative;
  }

  .histogram {
    display: flex;
    align-items: flex-end;
    gap: 2px;
    height: 120px;
    padding: 0.5rem 0;
  }

  .tooltip {
    position: absolute;
    top: 0;
    right: 0;
    font-size: 0.75rem;
    color: var(--text-secondary);
    opacity: 0;
    transition: opacity 0.15s;
    pointer-events: none;
  }

  .bar {
    flex: 1;
    background: var(--text-primary);
    min-width: 2px;
    transition: opacity 0.15s;
    cursor: pointer;
  }

  .bar:hover {
    opacity: 0.7;
  }

  .histogram-labels {
    display: flex;
    justify-content: space-between;
    font-size: 0.75rem;
    color: var(--text-secondary);
    margin-top: 0.25rem;
  }

  .loading, .error {
    font-size: 0.85rem;
    color: var(--text-secondary);
  }

  @media (max-width: 768px) {
    .histogram {
      height: 80px;
    }
  }
</style>
