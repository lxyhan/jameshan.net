---
import IndexLayout from '@/layouts/IndexLayout.astro'
import { themeConfig } from '@/config'
---

<IndexLayout
  title={`Analytics Â· ${themeConfig.site.title}`}
  description="Site analytics and statistics"
  hideHeader={true}
>
  <div class="analytics-page">
    <h1>Analytics</h1>

    <p class="methodology">Page views are recorded to a Supabase Postgres database on each request. Bot traffic is identified using user-agent pattern matching and excluded from counts. To prevent artificial inflation from page refreshes or rapid navigation, views from the same IP address to the same page within a 2.5-minute window are deduplicated at query time. IP addresses are stored as SHA-256 hashes, not in plaintext. No cookies are used, no fingerprinting, no third-party scripts. The raw view data is queried client-side and aggregated in the browser.</p>

    <div class="stats-row">
      <div class="stat">
        <span class="stat-value" id="today-views"></span>
        <span class="stat-label">views today</span>
      </div>
      <div class="stat">
        <span class="stat-value" id="all-views"></span>
        <span class="stat-label">views all time</span>
      </div>
    </div>

    <div class="histogram-section">
      <div class="histogram-header">
        <h2>Last <select id="days-select">
          <option value="7">7</option>
          <option value="30">30</option>
          <option value="60" selected>60</option>
        </select> days</h2>
      </div>
      <div class="histogram-container">
        <div class="y-axis" id="y-axis">
          <span id="y-max"></span>
          <span id="y-mid"></span>
          <span id="y-min">0</span>
        </div>
        <div class="histogram" id="histogram">
                  </div>
        <div class="tooltip" id="tooltip"></div>
      </div>
      <div class="histogram-labels">
        <span id="start-date">...</span>
        <span id="end-date">...</span>
      </div>
    </div>

    <div class="locations-section">
      <h2>Visitor locations</h2>
      <div class="locations-list" id="locations-list">
        <span class="loading-text">Loading...</span>
      </div>
    </div>
  </div>
</IndexLayout>

<script>
  const STATS_CACHE_KEY = 'analytics_stats_cache';

  function showStats(data: any) {
    const todayEl = document.getElementById('today-views');
    const allEl = document.getElementById('all-views');
    if (todayEl && data?.humanToday !== undefined) {
      todayEl.textContent = data.humanToday?.toLocaleString() || '0';
      todayEl.classList.add('loaded');
    }
    if (allEl && data?.humanAllTime !== undefined) {
      allEl.textContent = data.humanAllTime?.toLocaleString() || '0';
      allEl.classList.add('loaded');
    }
  }

  async function loadStats() {
    // Show cached data immediately
    const cached = localStorage.getItem(STATS_CACHE_KEY);
    if (cached) {
      try {
        showStats(JSON.parse(cached));
      } catch { /* ignore parse errors */ }
    }

    // Fetch fresh data
    try {
      const response = await fetch('/api/analytics');
      if (response.ok) {
        const data = await response.json();
        localStorage.setItem(STATS_CACHE_KEY, JSON.stringify(data));
        showStats(data);
      }
    } catch (error) {
      console.debug('Failed to load stats:', error);
    }
  }

  function getHistogramCacheKey(days: number) {
    return `analytics_histogram_${days}`;
  }

  function showHistogram(data: any) {
    const container = document.getElementById('histogram');
    const startLabel = document.getElementById('start-date');
    const endLabel = document.getElementById('end-date');
    const tooltip = document.getElementById('tooltip');

    if (container && data?.days && data.days.length > 0) {
      const maxViews = Math.max(...data.days.map((d: any) => d.views), 1);

      container.innerHTML = data.days.map((day: any) => {
        const height = Math.max((day.views / maxViews) * 100, 2);
        return `<div class="bar" style="height: ${height}%" data-date="${day.date}" data-views="${day.views}"></div>`;
      }).join('');

      container.classList.add('loaded');

      // Update y-axis labels
      const yMax = document.getElementById('y-max');
      const yMid = document.getElementById('y-mid');
      if (yMax) yMax.textContent = maxViews.toString();
      if (yMid) yMid.textContent = Math.round(maxViews / 2).toString();

      // Add hover listeners
      container.querySelectorAll('.bar').forEach(bar => {
        bar.addEventListener('mouseenter', (e) => {
          const target = e.target as HTMLElement;
          const date = new Date(target.dataset.date + 'T00:00:00');
          const formatted = date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
          const views = target.dataset.views;
          if (tooltip) {
            tooltip.textContent = `${formatted}: ${views} views`;
            tooltip.style.opacity = '1';
          }
        });
        bar.addEventListener('mouseleave', () => {
          if (tooltip) tooltip.style.opacity = '0';
        });
      });

      if (startLabel && data.days[0]) {
        const d = new Date(data.days[0].date + 'T00:00:00');
        startLabel.textContent = d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
      }
      if (endLabel && data.days[data.days.length - 1]) {
        const d = new Date(data.days[data.days.length - 1].date + 'T00:00:00');
        endLabel.textContent = d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
      }
    }
  }

  async function loadHistogram(days = 60) {
    const cacheKey = getHistogramCacheKey(days);

    // Show cached data immediately
    const cached = localStorage.getItem(cacheKey);
    if (cached) {
      try {
        showHistogram(JSON.parse(cached));
      } catch { /* ignore parse errors */ }
    }

    // Fetch fresh data
    try {
      const response = await fetch(`/api/analytics/daily?days=${days}`);
      if (response.ok) {
        const data = await response.json();
        localStorage.setItem(cacheKey, JSON.stringify(data));
        showHistogram(data);
      }
    } catch (error) {
      console.debug('Failed to load histogram:', error);
    }
  }

  // Dropdown handler
  const daysSelect = document.getElementById('days-select') as HTMLSelectElement;
  if (daysSelect) {
    daysSelect.addEventListener('change', () => {
      loadHistogram(parseInt(daysSelect.value, 10));
    });
  }

  // Country code to name mapping
  const countryNames: Record<string, string> = {
    US: 'United States', CA: 'Canada', GB: 'United Kingdom', DE: 'Germany',
    FR: 'France', JP: 'Japan', AU: 'Australia', CN: 'China', IN: 'India',
    BR: 'Brazil', MX: 'Mexico', KR: 'South Korea', IT: 'Italy', ES: 'Spain',
    NL: 'Netherlands', SE: 'Sweden', NO: 'Norway', DK: 'Denmark', FI: 'Finland',
    PL: 'Poland', RU: 'Russia', UA: 'Ukraine', SG: 'Singapore', HK: 'Hong Kong',
    TW: 'Taiwan', NZ: 'New Zealand', IE: 'Ireland', CH: 'Switzerland', AT: 'Austria',
    BE: 'Belgium', PT: 'Portugal', CZ: 'Czech Republic', RO: 'Romania', HU: 'Hungary',
    GR: 'Greece', IL: 'Israel', AE: 'UAE', SA: 'Saudi Arabia', ZA: 'South Africa',
    AR: 'Argentina', CL: 'Chile', CO: 'Colombia', PH: 'Philippines', MY: 'Malaysia',
    TH: 'Thailand', VN: 'Vietnam', ID: 'Indonesia', PK: 'Pakistan', BD: 'Bangladesh',
    EG: 'Egypt', NG: 'Nigeria', KE: 'Kenya', TR: 'Turkey',
  };

  function showLocations(data: { countries: Record<string, number>, total: number }) {
    const container = document.getElementById('locations-list');
    if (!container) return;

    const entries = Object.entries(data.countries);
    if (entries.length === 0) {
      container.innerHTML = '<span class="no-data">No location data yet</span>';
      return;
    }

    container.innerHTML = entries
      .slice(0, 15) // Show top 15 countries
      .map(([code, count]) => {
        const name = countryNames[code] || code;
        const percent = ((count / data.total) * 100).toFixed(1);
        return `<div class="location-item">
          <span class="country-name">${name}</span>
          <span class="country-count">${count} (${percent}%)</span>
        </div>`;
      })
      .join('');

    container.classList.add('loaded');
  }

  async function loadLocations() {
    const cacheKey = 'analytics_locations_cache';

    // Show cached data immediately
    const cached = localStorage.getItem(cacheKey);
    if (cached) {
      try {
        showLocations(JSON.parse(cached));
      } catch { /* ignore parse errors */ }
    }

    // Fetch fresh data
    try {
      const response = await fetch('/api/analytics/locations');
      if (response.ok) {
        const data = await response.json();
        localStorage.setItem(cacheKey, JSON.stringify(data));
        showLocations(data);
      }
    } catch (error) {
      console.debug('Failed to load locations:', error);
    }
  }

  loadStats();
  loadHistogram(60);
  loadLocations();

  document.addEventListener('astro:page-load', () => {
    loadStats();
    loadHistogram();
    loadLocations();
  });
</script>

<style is:global>
  .analytics-page {
    max-width: 100%;
  }

  h1 {
    font-size: 1rem;
    margin-bottom: 1rem;
    font-weight: var(--font-weight-bold);
  }

  h2 {
    font-size: 0.85rem;
    margin-bottom: 0.5rem;
    color: var(--text-secondary);
    font-weight: normal;
  }

  .stats-row {
    display: flex;
    gap: 2rem;
    margin-bottom: 2rem;
  }

  .stat {
    display: flex;
    flex-direction: column;
  }

  .stat-value {
    font-size: 1.5rem;
    font-weight: var(--font-weight-bold);
    line-height: 1.2;
  }

  .stat-label {
    font-size: 0.8rem;
    color: var(--text-secondary);
  }

  .methodology {
    font-size: 0.8rem;
    color: var(--text-secondary);
    margin-bottom: 1.5rem;
    line-height: 1.5;
  }

  .methodology a {
    color: var(--text-secondary);
    text-decoration: underline;
  }

  .histogram-section {
    margin-top: 1.5rem;
  }

  .histogram-header {
    display: flex;
    align-items: center;
  }

  .histogram-header h2 {
    display: flex;
    align-items: center;
    gap: 0.25rem;
  }

  #days-select {
    font-size: 0.85rem;
    font-family: inherit;
    background: transparent;
    border: none;
    border-bottom: 1px solid var(--text-secondary);
    color: var(--text-primary);
    cursor: pointer;
    padding: 0 0.25rem;
  }

  #days-select:focus {
    outline: none;
    border-bottom-color: var(--text-primary);
  }

  .histogram-container {
    position: relative;
    display: flex;
    gap: 0.5rem;
  }

  .y-axis {
    display: flex;
    flex-direction: column;
    justify-content: space-between;
    align-items: flex-end;
    height: 120px;
    padding: 0.5rem 0;
    font-size: 0.65rem;
    color: var(--text-secondary);
    min-width: 24px;
  }

  .histogram {
    display: flex;
    align-items: flex-end;
    gap: 2px;
    height: 120px;
    padding: 0.5rem 0;
    flex: 1;
  }

  .tooltip {
    position: absolute;
    top: 0;
    right: 0;
    font-size: 0.75rem;
    color: var(--text-secondary);
    opacity: 0;
    transition: opacity 0.15s;
    pointer-events: none;
  }

  .bar {
    flex: 1;
    background: var(--text-primary);
    min-width: 2px;
    transition: opacity 0.15s;
    cursor: pointer;
  }

  .bar:hover {
    opacity: 0.7;
  }

  .histogram-labels {
    display: flex;
    justify-content: space-between;
    font-size: 0.75rem;
    color: var(--text-secondary);
    margin-top: 0.25rem;
  }

  .stat-value {
    opacity: 0;
    transition: opacity 0.3s ease;
    display: inline-block;
    min-width: 45px;
    min-height: 1.8rem;
  }

  .stat-value.loaded {
    opacity: 1;
  }

  .histogram {
    opacity: 0;
    transition: opacity 0.4s ease;
  }

  .histogram.loaded {
    opacity: 1;
  }

  @media (max-width: 768px) {
    .histogram {
      height: 80px;
    }
    .y-axis {
      height: 80px;
    }
  }

  .locations-section {
    margin-top: 2rem;
  }

  .locations-list {
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
    opacity: 0;
    transition: opacity 0.3s ease;
  }

  .locations-list.loaded {
    opacity: 1;
  }

  .loading-text, .no-data {
    font-size: 0.8rem;
    color: var(--text-secondary);
  }

  .location-item {
    display: flex;
    justify-content: space-between;
    font-size: 0.85rem;
    padding: 0.25rem 0;
    border-bottom: 1px solid var(--border);
  }

  .location-item:last-child {
    border-bottom: none;
  }

  .country-name {
    color: var(--text-primary);
  }

  .country-count {
    color: var(--text-secondary);
    font-size: 0.8rem;
  }
</style>
