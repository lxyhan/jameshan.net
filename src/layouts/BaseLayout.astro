---
import { themeConfig } from '@/config'
import { ViewTransitions } from 'astro:transitions'
import ThemeManager from '@/components/ui/ThemeManager.astro'
import FaviconThemeSwitcher from '@/components/ui/FaviconThemeSwitcher.astro'
import TransitionWrapper from '@/components/layout/TransitionWrapper.astro'
import BlogTree from '@/components/widgets/BlogTree.astro'
import Footer from '@/components/layout/Footer.astro'
import ImageViewer from '@/components/ui/ImageViewer.astro'
import { getSortedFilteredPosts } from '@/utils/draft'
import type { LayoutProps } from '@/types'

type Props = LayoutProps & {
  blogTreeFirst?: boolean
}

const { type = 'page', blogTreeFirst = false } = Astro.props
const language = themeConfig.site.language || 'en-US'
const fadeAnimation = themeConfig.general.fadeAnimation

const posts = await getSortedFilteredPosts()
---

<html lang={language}>
  <head>
    <script is:inline>
      // Apply font preference immediately to prevent flash
      (function() {
        const savedFont = localStorage.getItem('font-preference') || 'serif';
        document.documentElement.setAttribute('data-font', savedFont);
      })();
    </script>
    <ThemeManager />
    <ViewTransitions />
    <slot name="head" />
  </head>
  <body data-centered={themeConfig.general.centeredLayout}>
    <FaviconThemeSwitcher />
    
    <script is:inline>
      // Smooth page transitions
      document.addEventListener('astro:before-preparation', () => {
        document.body.style.transition = 'opacity 0.2s ease-out';
        document.body.style.opacity = '0';
      });
      
      document.addEventListener('astro:after-swap', () => {
        document.body.style.transition = 'opacity 0.3s ease-out';
        document.body.style.opacity = '1';
      });
    </script>

    <div class="site-grid">
      <div class="main-column">
        {
          fadeAnimation ? (
            <TransitionWrapper type={type} class="layout-wrapper">
              {/* STRUCTURAL CHANGE: We created a grid container here */}
              <div class={`two-col-grid ${blogTreeFirst ? 'blog-tree-first' : ''}`}>
                
                {/* COL 1: Sidebar (Blog Tree) */}
                <aside class="sidebar-area">
                  <div class="blog-tree-sticky">
                    <BlogTree posts={posts} />
                  </div>
                </aside>

                {/* COL 2: Main Content (About, Posts, etc) */}
                <main class="content-area">
                  <slot />
                </main>

              </div>
            </TransitionWrapper>
          ) : (
            <div class="layout-wrapper">
              <div class={`two-col-grid ${blogTreeFirst ? 'blog-tree-first' : ''}`}>
                <aside class="sidebar-area">
                  <div class="blog-tree-sticky">
                    <BlogTree posts={posts} />
                  </div>
                </aside>
                <main class="content-area">
                  <slot />
                </main>
              </div>
            </div>
          )
        }
      </div>
      {themeConfig.general.footer && (
        <div class="footer-wrapper">
          <Footer />
        </div>
      )}
    </div>
    <ImageViewer />
  </body>
</html>

<style is:global>
  /* 1. Base Site Setup */
  .site-grid {
    width: 100%;
    margin: 0 auto;
    min-height: 100vh;
  }

  .main-column {
    width: 100%;
    padding: 0;
  }
  
  @media (max-width: 768px) {
    .main-column {
      padding: 0;
    }
  }

  .layout-wrapper {
    display: flex;
    flex-direction: column;
    min-height: calc(100vh - 7.5rem);
    width: 100%;
  }

  /* 2. The Grid Container */
  /* This holds the Main Content and the Sidebar side-by-side on desktop */
  .two-col-grid {
    width: 100%;
    margin: 0 auto;
    display: flex; /* Default to mobile stack */
    flex-direction: column;
  }

  /* 3. Main Content Area */
  .content-area {
    width: 100%;
    max-width: 100ch; /* Increased from 65ch for better readability */
    margin: 0 auto; /* Center on mobile */
    display: flex;
    flex-direction: column;
    padding: 0 1.5rem; /* Add padding on mobile */
    order: 1; /* Show content first on mobile */
    overflow-x: hidden; /* Prevent horizontal overflow */
    box-sizing: border-box;
  }

  /* 4. Sidebar Area (Mobile Defaults) */
  .sidebar-area {
    width: 100%;
    max-width: 100ch; /* Match content-area max-width */
    margin: 1.5rem auto 0; /* Reduced space between about and blog tree */
    padding: 0 1.5rem; /* Add padding on mobile */
    border-top: none; /* Remove border */
    order: 2; /* Show blog tree at bottom on mobile by default */
  }

  /* Blog tree first on mobile for post pages */
  .two-col-grid.blog-tree-first .sidebar-area {
    order: 0; /* Show blog tree at top on mobile */
    margin: 0 auto 1.5rem; /* Margin at bottom instead of top */
  }

  .two-col-grid.blog-tree-first .content-area {
    order: 1; /* Content comes after blog tree */
  }

  /* 5. Medium Screen Logic (Tablets) */
  @media (min-width: 768px) and (max-width: 1279px) {
    /* Keep stacked layout but improve spacing */
    .content-area {
      max-width: 90%; /* Prevent content from being too wide */
      margin: 0 auto; /* Center the content */
      padding: 0;
    }

    .sidebar-area {
      max-width: 90%;
      margin: 3rem auto 0; /* Center the sidebar */
      padding: 2rem 1.5rem 0 1.5rem;
    }
  }

  /* 6. Desktop Logic (The fix you requested) */
  @media (min-width: 1280px) {
    
    .site-grid {
      display: block; /* Ensure no flex interference */
    }

    .main-column {
      display: block; /* Ensure no flex interference */
    }

    .layout-wrapper {
      display: block; /* Override flex to allow grid to work */
      min-height: auto; /* Remove min-height constraint */
    }

    /* Turn on the Grid - content centered, filetree in margin */
    .two-col-grid {
      display: block !important;
      max-width: none;
      margin: 0 auto;
      padding-top: 2rem;
      position: relative;
    }

    /* Main Content - Always centered */
    .content-area {
      margin: 0 auto;
      max-width: 100ch;
      width: 100ch; /* Force fixed width */
      padding: 0 2rem;
      display: flex;
      flex-direction: column;
      box-sizing: border-box;
      position: relative;
    }

    /* Sidebar - Positioned absolutely relative to viewport */
    .sidebar-area {
      position: absolute;
      left: calc(50vw - 50ch - 300px - 2rem); /* Left of centered content */
      top: 2rem;
      margin: 0;
      padding: 0;
      max-width: 300px;
      width: 300px;
      border-top: none;
    }

    /* Sticky Behavior - follows content */
    .blog-tree-sticky {
      position: relative;
      max-height: none;
    }

    /* Ensure consistent positioning for different page types */
    .page-content,
    .post-container {
      display: block; /* Override flex */
      margin: 0;
      padding: 0;
    }

    .page-content main,
    .post-container main {
      display: block;
      margin: 0;
      padding: 0;
    }

    /* Reset any extra spacing in post articles */
    .post-article {
      margin: 0 !important; /* Remove all margins including horizontal centering */
      padding-top: 0 !important;
      max-width: none !important; /* Remove max-width constraint */
    }

    /* Reset any extra spacing in page content */
    .page-content > div {
      margin: 0 !important;
    }

    /* Ensure post-inner doesn't add extra layout */
    .post-inner {
      margin: 0 !important;
      padding: 0 !important;
    }
  }

  /* Footer wrapper - at the very bottom */
  .footer-wrapper {
    width: 100%;
    max-width: 100ch;
    margin: 0 auto;
    padding: 0 1.5rem; /* Add padding on mobile */
  }

  @media (min-width: 768px) and (max-width: 1279px) {
    .footer-wrapper {
      max-width: 90%;
      padding: 0 1.5rem;
    }
  }

  @media (min-width: 1280px) {
    .footer-wrapper {
      padding: 0 2rem;
    }
  }

  /* Footer offset adjustments */
  @media (max-width: 768px) {
    .layout-wrapper {
      min-height: calc(100vh - 5.5rem);
    }
  }
</style>