---
import '@/styles/global.css'
import type { PostLayoutProps } from '@/types'
import FormattedDate from '@/components/widgets/FormattedDate.astro'
import FootnoteScroll from '@/components/widgets/FootnoteScroll.astro'
import BaseHead from '@/components/layout/BaseHead.astro'
import Footer from '@/components/layout/Footer.astro'
import Breadcrumb from '@/components/ui/Breadcrumb.astro'
import TableOfContents from '@/components/ui/TableOfContents.astro'
import GradientMask from '@/components/ui/GradientMask.astro'
import ImageOptimizer from '@/components/ui/ImageOptimizer.astro'
import ImageViewer from '@/components/ui/ImageViewer.astro'
import GitHubCard from '@/components/ui/GitHubCard.astro'
import LinkCard from '@/components/ui/LinkCard.astro'
import NeoDBCard from '@/components/ui/NeoDBCard.astro'
import XPOST from '@/components/ui/XPOST.astro'
import CopyCode from '@/components/ui/CopyCode.astro'
import PostNavigation from '@/components/widgets/PostNavigation.astro'
import PostLikes from '@/components/comments/PostLikes.astro'
import PostViews from '@/components/widgets/PostViews.astro'
import BaseLayout from '@/layouts/BaseLayout.astro'

import { themeConfig } from '@/config'

const { title, pubDate, readingTime, toc, postId } = Astro.props as PostLayoutProps & { postId: string }

const postSlug = Astro.url.pathname.split('/').filter(Boolean).pop() || ''
const postPath = Astro.url.pathname
const ogImage = `/open-graph/${postSlug}.png`
---

<BaseLayout
  title={`${title} · ${themeConfig.site.title}`}
  description={themeConfig.site.description}
  type="post"
  blogTreeFirst={true}
>
  <BaseHead
    title={`${title} · ${themeConfig.site.title}`}
    description={themeConfig.site.description}
    ogImage={ogImage}
    slot="head"
  />
  <div class="post-container">
    <main>
      <div class="post-inner">
        <!-- <aside class="post-rail" aria-label="Post navigation">
          <BackButton />
          {themeConfig.post.toc && <TableOfContents toc={toc} />}
        </aside> -->
        <article class="post-article prose">
          <GradientMask />
          <div class="post-header">
            <Breadcrumb postId={postId} title={title} />
            <div class="date">
              <PostLikes slug={postSlug} />
              <span class="separator" style="margin: 0 0.5rem;">|</span>
              <PostViews path={postPath} />
              <span class="separator" style="margin: 0 0.5rem;">|</span>
              <FormattedDate date={pubDate} context="post" />
              {
                themeConfig.post.readingTime && readingTime && (
                  <span class="reading-time">
                    <span class="separator">·</span>
                    {readingTime.text}
                  </span>
                )
              }
            </div>
          </div>
          <h1 class="post-title">{title}</h1>
          <slot />
          <PostNavigation currentPostId={postId} />
        </article>
      </div>
    </main>
    <ImageOptimizer />
    <FootnoteScroll />
    <CopyCode />
    <GitHubCard />
    <XPOST />
    <NeoDBCard />
    {themeConfig.post.linkCard && <LinkCard />}
    {themeConfig.general.footer && <Footer />}
  </div>
  <script>
    // Force code highlighting to apply on View Transitions navigation
    function refreshCodeHighlighting() {
      document.querySelectorAll('.astro-code span[style]').forEach(span => {
        // Force style recalculation by reading computed style
        void span.offsetHeight
      })
    }
    document.addEventListener('astro:page-load', refreshCodeHighlighting)
    document.addEventListener('astro:after-swap', refreshCodeHighlighting)
  </script>
</BaseLayout>

<style>
  .post-container {
    display: flex;
    flex-direction: column;
    flex: 1;
  }

  .post-container main {
    flex: 1;
  }

  .post-inner {
    display: block;
    /* grid-template-columns: minmax(0, 10rem) minmax(0, 1fr);
    gap: 2rem;
    align-items: flex-start; */
  }

  .post-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 0.5rem;
    gap: 1rem;
  }

  .post-title {
    font-size: 1.5rem;
    font-weight: var(--font-weight-bold);
    line-height: 1.2;
    margin: 1rem 0 1rem 0;
    letter-spacing: -0.04em;
    font-stretch: condensed;
  }

  .post-rail {
    display: flex;
    flex-direction: column;
    gap: 1.25rem;
    font-size: var(--font-size-s);
    position: sticky;
    top: 5rem;
  }

  .post-article {
    min-width: 0;
    max-width: 100ch;
    margin: 0 auto;
  }

  @media (max-width: 1023px) {
    .post-inner {
      grid-template-columns: 1fr;
      gap: 1.5rem;
    }

    .post-rail {
      position: static;
      flex-direction: row;
      flex-wrap: wrap;
      align-items: center;
      justify-content: flex-start;
      gap: 1rem;
      border-bottom: 1px solid var(--border);
      padding-bottom: 1rem;
    }
  }
</style>

<style is:global>
  /* Make TOC visible inside the post rail (TableOfContents lives in a child component) */
  .post-rail .toc-container {
    opacity: 1 !important;
    display: block !important;
  }

  .post-rail .toc-link {
    color: var(--text-secondary) !important;
    font-size: var(--font-size-s) !important;
    line-height: 1.3;
    text-indent: 0;
    height: auto;
    width: auto;
  }

  /* Disable ghost pseudo-elements inside the rail; show plain text instead */
  .post-rail .toc-link::after,
  .post-rail .toc-link::before {
    content: none !important;
  }
</style>
